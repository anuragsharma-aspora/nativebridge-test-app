name: Release Build

# Trigger on release tags (e.g., v1.0.0, v1.2.3, v2.0.0-beta)
on:
  push:
    tags:
      - 'v*'

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # Android APK Build
  # ============================================================================
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Extract version from tag
      - name: Extract version from tag
        id: get_version
        run: |
          # Get tag name (e.g., v1.0.0)
          TAG_NAME=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix to get version (e.g., 1.0.0)
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Set up Java/JDK for Android build
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # Generate or decode keystore
      - name: Setup Android Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Create keystore directory
          mkdir -p android/app

          # If keystore secret exists, decode it; otherwise generate a new one
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "Using keystore from GitHub Secrets"
            echo $KEYSTORE_BASE64 | base64 -d > android/app/release.keystore
            KEYSTORE_FILE="release.keystore"
            KEYSTORE_PASSWORD="${KEYSTORE_PASSWORD}"
            KEY_ALIAS="${KEY_ALIAS}"
            KEY_PASSWORD="${KEY_PASSWORD}"
          else
            echo "No keystore secrets found - generating a new keystore for CI"
            KEYSTORE_FILE="ci-release.keystore"
            KEYSTORE_PASSWORD="nativebridge2025"
            KEY_ALIAS="nativebridge-key"
            KEY_PASSWORD="nativebridge2025"

            # Generate keystore
            keytool -genkeypair \
              -v \
              -storetype PKCS12 \
              -keystore android/app/$KEYSTORE_FILE \
              -alias $KEY_ALIAS \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass $KEYSTORE_PASSWORD \
              -keypass $KEY_PASSWORD \
              -dname "CN=NativeBridge CI, OU=Development, O=NativeBridge, L=City, ST=State, C=US"

            echo "âœ… Generated new keystore for CI build"
          fi

          # Create gradle.properties with signing config
          cat >> android/gradle.properties << EOF

          # Release signing configuration (from CI/CD)
          MYAPP_RELEASE_STORE_FILE=$KEYSTORE_FILE
          MYAPP_RELEASE_KEY_ALIAS=$KEY_ALIAS
          MYAPP_RELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD
          MYAPP_RELEASE_KEY_PASSWORD=$KEY_PASSWORD
          EOF

          echo "âœ… Keystore configured successfully"

      # Update version in build.gradle
      - name: Update version in build.gradle
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          # Generate versionCode: 1.0.0 -> 10000, 1.2.3 -> 10203
          VERSION_CODE=$(echo $VERSION | sed 's/-.*//' | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')

          # Update versionCode and versionName in build.gradle
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle

          echo "Updated to versionCode: $VERSION_CODE, versionName: $VERSION"

      # Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # Patch React Native Gradle Plugin to disable warnings as errors
      - name: Patch React Native Gradle Plugin
        run: |
          # Find and patch the build.gradle.kts file to force allWarningsAsErrors = false
          PLUGIN_BUILD_FILE="node_modules/@react-native/gradle-plugin/react-native-gradle-plugin/build.gradle.kts"

          if [ -f "$PLUGIN_BUILD_FILE" ]; then
            echo "Patching React Native Gradle Plugin build configuration..."

            # Force allWarningsAsErrors to false using sed
            sed -i 's/allWarningsAsErrors = true/allWarningsAsErrors = false/g' "$PLUGIN_BUILD_FILE"

            # Also add it if missing - insert before the closing brace of kotlinOptions
            if ! grep -q "allWarningsAsErrors" "$PLUGIN_BUILD_FILE"; then
              sed -i '/kotlinOptions {/a\    allWarningsAsErrors = false' "$PLUGIN_BUILD_FILE"
            fi

            echo "Patched successfully"
            grep -A 5 "kotlinOptions" "$PLUGIN_BUILD_FILE" || true
          fi

      # Add Gradle property to disable Kotlin warnings as errors globally
      - name: Configure Gradle Properties for CI
        run: |
          cat >> android/gradle.properties << 'EOF'

          # CI: Disable Kotlin warnings as errors
          kotlin.allWarningsAsErrors=false
          kotlin.suppressWarnings=true

          # Gradle performance settings for CI
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          EOF

      # Build Android Release APK
      - name: Build Android Release APK
        run: |
          cd android

          # Clean first
          ./gradlew clean

          # Build release APK with Kotlin compiler args to suppress warnings
          ./gradlew assembleRelease \
            --stacktrace \
            -Dkotlin.compiler.execution.strategy=in-process \
            -Pkotlin.allWarningsAsErrors=false

      # Rename APK with version
      - name: Rename APK with version
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          mkdir -p release-artifacts
          cp android/app/build/outputs/apk/release/app-release.apk \
             release-artifacts/NativeBridge-v${VERSION}.apk

          # Get file size
          FILE_SIZE=$(ls -lh release-artifacts/NativeBridge-v${VERSION}.apk | awk '{print $5}')
          echo "APK Size: $FILE_SIZE"
          echo "APK_SIZE=$FILE_SIZE" >> $GITHUB_ENV

      # Upload APK as artifact
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: NativeBridge-Android-v${{ steps.get_version.outputs.VERSION }}
          path: release-artifacts/NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk
          retention-days: 90

      # Output build info
      - name: Build Summary
        run: |
          echo "### Android Build Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK:** NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ env.APK_SIZE }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Extract version from tag
      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      # Download Android artifact
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: NativeBridge-Android-v${{ steps.get_version.outputs.VERSION }}
          path: artifacts/

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.TAG_NAME }}
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.TAG_NAME, 'beta') || contains(steps.get_version.outputs.TAG_NAME, 'alpha') }}
          body: |
            ## NativeBridge Release ${{ steps.get_version.outputs.VERSION }}

            ### ðŸ“¦ Downloads

            **Android:**
            - `NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk` - Production APK for Android devices and emulators

            ### ðŸ“ Installation

            **Android:**
            ```bash
            adb install NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk
            ```

            ### âœ¨ Features
            - UI Components testing
            - Network Operations testing
            - Performance testing
            - Permissions testing
            - Storage operations
            - File operations
            - Biometric authentication testing
            - QR Code scanning
            - Comprehensive logging

            ### ðŸ“‹ Build Information
            - **Built on:** ${{ github.event.repository.updated_at }}
            - **Commit:** ${{ github.sha }}
            - **Tag:** ${{ steps.get_version.outputs.TAG_NAME }}

            ---

            For detailed build instructions, see [BUILD_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/BUILD_GUIDE.md)
          files: |
            artifacts/NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Final summary
      - name: Release Summary
        run: |
          echo "### ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android APK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
