name: Release Build

# Trigger on release tags (e.g., v1.0.0, v1.2.3, v2.0.0-beta)
on:
  push:
    tags:
      - 'v*'

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # Android APK Build
  # ============================================================================
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    outputs:
      nativebridge_link: ${{ steps.nativebridge_upload.outputs.magic_link }}
      nativebridge_versioned_link: ${{ steps.nativebridge_upload.outputs.versioned_link }}
      nativebridge_version: ${{ steps.nativebridge_upload.outputs.nb_version }}
      nativebridge_app_id: ${{ steps.nativebridge_upload.outputs.app_id }}

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Extract version from tag
      - name: Extract version from tag
        id: get_version
        run: |
          # Get tag name (e.g., v1.0.0)
          TAG_NAME=${GITHUB_REF#refs/tags/}
          # Remove 'v' prefix to get version (e.g., 1.0.0)
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Set up Java/JDK for Android build
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # Generate or decode keystore
      - name: Setup Android Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Create keystore directory
          mkdir -p android/app

          # If keystore secret exists, decode it; otherwise generate a new one
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "Using keystore from GitHub Secrets"
            echo $KEYSTORE_BASE64 | base64 -d > android/app/release.keystore
            KEYSTORE_FILE="release.keystore"
            KEYSTORE_PASSWORD="${KEYSTORE_PASSWORD}"
            KEY_ALIAS="${KEY_ALIAS}"
            KEY_PASSWORD="${KEY_PASSWORD}"
          else
            echo "No keystore secrets found - generating a new keystore for CI"
            KEYSTORE_FILE="ci-release.keystore"
            KEYSTORE_PASSWORD="nativebridge2025"
            KEY_ALIAS="nativebridge-key"
            KEY_PASSWORD="nativebridge2025"

            # Generate keystore
            keytool -genkeypair \
              -v \
              -storetype PKCS12 \
              -keystore android/app/$KEYSTORE_FILE \
              -alias $KEY_ALIAS \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass $KEYSTORE_PASSWORD \
              -keypass $KEY_PASSWORD \
              -dname "CN=NativeBridge CI, OU=Development, O=NativeBridge, L=City, ST=State, C=US"

            echo "âœ… Generated new keystore for CI build"
          fi

          # Create gradle.properties with signing config
          cat >> android/gradle.properties << EOF

          # Release signing configuration (from CI/CD)
          MYAPP_RELEASE_STORE_FILE=$KEYSTORE_FILE
          MYAPP_RELEASE_KEY_ALIAS=$KEY_ALIAS
          MYAPP_RELEASE_STORE_PASSWORD=$KEYSTORE_PASSWORD
          MYAPP_RELEASE_KEY_PASSWORD=$KEY_PASSWORD
          EOF

          echo "âœ… Keystore configured successfully"

      # Update version in build.gradle
      - name: Update version in build.gradle
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          # Generate versionCode: 1.0.0 -> 10000, 1.2.3 -> 10203
          VERSION_CODE=$(echo $VERSION | sed 's/-.*//' | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')

          # Update versionCode and versionName in build.gradle
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle

          echo "Updated to versionCode: $VERSION_CODE, versionName: $VERSION"

      # Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # Patch React Native Gradle Plugin to disable warnings as errors
      - name: Patch React Native Gradle Plugin
        run: |
          # Find and patch the build.gradle.kts file to force allWarningsAsErrors = false
          PLUGIN_BUILD_FILE="node_modules/@react-native/gradle-plugin/react-native-gradle-plugin/build.gradle.kts"

          if [ -f "$PLUGIN_BUILD_FILE" ]; then
            echo "Patching React Native Gradle Plugin build configuration..."

            # Force allWarningsAsErrors to false using sed
            sed -i 's/allWarningsAsErrors = true/allWarningsAsErrors = false/g' "$PLUGIN_BUILD_FILE"

            # Also add it if missing - insert before the closing brace of kotlinOptions
            if ! grep -q "allWarningsAsErrors" "$PLUGIN_BUILD_FILE"; then
              sed -i '/kotlinOptions {/a\    allWarningsAsErrors = false' "$PLUGIN_BUILD_FILE"
            fi

            echo "Patched successfully"
            grep -A 5 "kotlinOptions" "$PLUGIN_BUILD_FILE" || true
          fi

      # Add Gradle property to disable Kotlin warnings as errors globally
      - name: Configure Gradle Properties for CI
        run: |
          cat >> android/gradle.properties << 'EOF'

          # CI: Disable Kotlin warnings as errors
          kotlin.allWarningsAsErrors=false
          kotlin.suppressWarnings=true

          # Gradle performance settings for CI
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.caching=true
          org.gradle.configureondemand=true
          EOF

      # Build Android Release APK
      - name: Build Android Release APK
        run: |
          cd android

          # Clean first
          ./gradlew clean

          # Build release APK with Kotlin compiler args to suppress warnings
          ./gradlew assembleRelease \
            --stacktrace \
            -Dkotlin.compiler.execution.strategy=in-process \
            -Pkotlin.allWarningsAsErrors=false

      # Rename APK with version
      - name: Rename APK with version
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          mkdir -p release-artifacts
          cp android/app/build/outputs/apk/release/app-release.apk \
             release-artifacts/NativeBridge-v${VERSION}.apk

          # Get file size
          FILE_SIZE=$(ls -lh release-artifacts/NativeBridge-v${VERSION}.apk | awk '{print $5}')
          echo "APK Size: $FILE_SIZE"
          echo "APK_SIZE=$FILE_SIZE" >> $GITHUB_ENV

      # Upload APK as artifact
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: NativeBridge-Android-v${{ steps.get_version.outputs.VERSION }}
          path: release-artifacts/NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk
          retention-days: 90

      # Upload to NativeBridge Platform
      - name: Upload APK to NativeBridge
        id: nativebridge_upload
        env:
          NATIVEBRIDGE_API_KEY: ${{ secrets.NATIVEBRIDGE_API_KEY }}
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          APK_PATH="release-artifacts/NativeBridge-v${VERSION}.apk"

          if [ -z "$NATIVEBRIDGE_API_KEY" ]; then
            echo "âš ï¸  NATIVEBRIDGE_API_KEY secret not configured - skipping NativeBridge upload"
            echo "To enable NativeBridge uploads, add NATIVEBRIDGE_API_KEY to GitHub Secrets"
            exit 0
          fi

          echo "ðŸ“¤ Uploading APK to NativeBridge..."

          # Upload to NativeBridge API
          RESPONSE=$(curl -X POST https://api.nativebridge.io/v1/application \
            -H "X-Api-Key: $NATIVEBRIDGE_API_KEY" \
            -F "file=@$APK_PATH" \
            -F "accessType=public" \
            -F "versionAction=create_new_version" \
            -F "sendNotification=true" \
            -w "\n%{http_code}" \
            -s)

          # Extract HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Successfully uploaded to NativeBridge!"

            # Parse response using grep and sed
            MAGIC_LINK=$(echo "$BODY" | grep -o '"magicLink":"[^"]*"' | sed 's/"magicLink":"//;s/"//')
            VERSIONED_LINK=$(echo "$BODY" | grep -o '"versionedMagicLink":"[^"]*"' | sed 's/"versionedMagicLink":"//;s/"//')
            NB_VERSION=$(echo "$BODY" | grep -o '"version":"[^"]*"' | sed 's/"version":"//;s/"//')
            APP_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | sed 's/"id":"//;s/"//')

            echo "ðŸ“± App ID: $APP_ID"
            echo "ðŸ”¢ NativeBridge Version: $NB_VERSION"
            echo "ðŸ”— Magic Link (Latest): $MAGIC_LINK"
            echo "ðŸ”— Versioned Link: $VERSIONED_LINK"

            # Save to environment for later steps
            echo "NATIVEBRIDGE_LINK=$MAGIC_LINK" >> $GITHUB_ENV
            echo "NATIVEBRIDGE_VERSIONED_LINK=$VERSIONED_LINK" >> $GITHUB_ENV
            echo "NATIVEBRIDGE_VERSION=$NB_VERSION" >> $GITHUB_ENV
            echo "NATIVEBRIDGE_APP_ID=$APP_ID" >> $GITHUB_ENV

            # Set outputs for create-release job
            echo "magic_link=$MAGIC_LINK" >> $GITHUB_OUTPUT
            echo "versioned_link=$VERSIONED_LINK" >> $GITHUB_OUTPUT
            echo "nb_version=$NB_VERSION" >> $GITHUB_OUTPUT
            echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to upload to NativeBridge (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      # Output build info
      - name: Build Summary
        run: |
          echo "### Android Build Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK:** NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ env.APK_SIZE }}" >> $GITHUB_STEP_SUMMARY

          # Add NativeBridge info if uploaded
          if [ -n "${{ env.NATIVEBRIDGE_LINK }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“± NativeBridge Upload âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**App ID:** ${{ env.NATIVEBRIDGE_APP_ID }}" >> $GITHUB_STEP_SUMMARY
            echo "**NativeBridge Version:** ${{ env.NATIVEBRIDGE_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Magic Link (Latest):** [${{ env.NATIVEBRIDGE_LINK }}](${{ env.NATIVEBRIDGE_LINK }})" >> $GITHUB_STEP_SUMMARY
            echo "**Versioned Link:** [${{ env.NATIVEBRIDGE_VERSIONED_LINK }}](${{ env.NATIVEBRIDGE_VERSIONED_LINK }})" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # iOS Simulator Build (Uses Pre-built App)
  # ============================================================================
  build-ios:
    name: Build iOS Simulator App
    runs-on: macos-latest
    outputs:
      nativebridge_link: ${{ steps.nativebridge_upload.outputs.magic_link }}
      nativebridge_versioned_link: ${{ steps.nativebridge_upload.outputs.versioned_link }}
      nativebridge_version: ${{ steps.nativebridge_upload.outputs.nb_version }}
      nativebridge_app_id: ${{ steps.nativebridge_upload.outputs.app_id }}

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Extract version from tag
      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      # NOTE: iOS builds are very resource-intensive in CI/CD environments.
      # Building React Native apps for both arm64 and x86_64 architectures can:
      # - Take 10+ minutes on GitHub Actions runners
      # - Consume significant CPU and memory
      # - Often timeout or fail due to resource exhaustion
      #
      # SOLUTION: Use pre-built .app.zip files
      # To create a new pre-built iOS app:
      # 1. Build locally: cd ios && pod install && xcodebuild -workspace NativeBridgeApp.xcworkspace \
      #    -scheme NativeBridgeApp -configuration Release -sdk iphonesimulator \
      #    -destination 'generic/platform=iOS Simulator' -derivedDataPath build clean build
      # 2. Zip the app: cd build/Build/Products/Release-iphonesimulator && \
      #    zip -r -y ../../../../prebuilt/NativeBridgeApp.app.zip NativeBridgeApp.app
      # 3. Commit: git add ios/prebuilt/NativeBridgeApp.app.zip && git commit -m "Update pre-built iOS app"
      #
      # This approach:
      # âœ… Completes in seconds instead of minutes
      # âœ… Uses minimal CI resources
      # âœ… Avoids architecture-specific build issues
      # âœ… Still provides instant cloud testing via NativeBridge

      # Uncomment below to enable actual iOS building (requires significant CI resources)
      # - name: Set up Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: ${{ env.NODE_VERSION }}
      #     cache: 'npm'
      #
      # - name: Install npm dependencies
      #   run: npm ci
      #
      # - name: Install CocoaPods dependencies
      #   run: |
      #     cd ios
      #     pod repo update
      #     pod install --repo-update
      #
      # - name: Set up Xcode
      #   run: |
      #     sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      #     xcodebuild -version
      #
      # - name: Build iOS .app for Simulator
      #   run: |
      #     VERSION=${{ steps.get_version.outputs.VERSION }}
      #     cd ios
      #     xcodebuild \
      #       -workspace NativeBridgeApp.xcworkspace \
      #       -scheme NativeBridgeApp \
      #       -configuration Release \
      #       -sdk iphonesimulator \
      #       -destination 'generic/platform=iOS Simulator' \
      #       -derivedDataPath build \
      #       MARKETING_VERSION=$VERSION \
      #       clean build
      #
      #     # Create zip
      #     cd build/Build/Products/Release-iphonesimulator
      #     mkdir -p ../../../../release-artifacts
      #     zip -r -y ../../../../release-artifacts/NativeBridge-iOS-v${VERSION}.app.zip NativeBridgeApp.app

      # Use pre-built iOS app (much faster and more reliable)
      - name: Use Pre-built iOS App
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}

          echo "ðŸ“± Using pre-built iOS app..."

          # Check if pre-built app exists
          if [ ! -f "ios/prebuilt/NativeBridgeApp.app.zip" ]; then
            echo "âŒ Pre-built iOS app not found at ios/prebuilt/NativeBridgeApp.app.zip"
            echo "Please build the app locally and commit the zip file. See comments above for instructions."
            exit 1
          fi

          # Create release artifacts directory
          mkdir -p release-artifacts

          # Copy pre-built app to release artifacts with versioned name
          cp ios/prebuilt/NativeBridgeApp.app.zip release-artifacts/NativeBridge-iOS-v${VERSION}.app.zip

          # Get file size
          ZIP_SIZE=$(ls -lh release-artifacts/NativeBridge-iOS-v${VERSION}.app.zip | awk '{print $5}')
          echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_ENV

          echo "âœ… Pre-built iOS app ready: NativeBridge-iOS-v${VERSION}.app.zip ($ZIP_SIZE)"

      # Upload as artifact
      - name: Upload iOS .app.zip
        uses: actions/upload-artifact@v4
        with:
          name: NativeBridge-iOS-v${{ steps.get_version.outputs.VERSION }}
          path: release-artifacts/NativeBridge-iOS-v${{ steps.get_version.outputs.VERSION }}.app.zip
          retention-days: 90

      # Upload to NativeBridge Platform
      - name: Upload iOS app to NativeBridge
        id: nativebridge_upload
        env:
          NATIVEBRIDGE_API_KEY: ${{ secrets.NATIVEBRIDGE_API_KEY }}
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          APP_PATH="release-artifacts/NativeBridge-iOS-v${VERSION}.app.zip"

          if [ -z "$NATIVEBRIDGE_API_KEY" ]; then
            echo "âš ï¸  NATIVEBRIDGE_API_KEY secret not configured - skipping NativeBridge upload"
            echo "To enable NativeBridge uploads, add NATIVEBRIDGE_API_KEY to GitHub Secrets"
            exit 0
          fi

          echo "ðŸ“¤ Uploading iOS app to NativeBridge..."

          # Upload to NativeBridge API
          RESPONSE=$(curl -X POST https://api.nativebridge.io/v1/application \
            -H "X-Api-Key: $NATIVEBRIDGE_API_KEY" \
            -F "file=@$APP_PATH" \
            -F "accessType=public" \
            -F "versionAction=create_new_version" \
            -F "sendNotification=true" \
            -w "\n%{http_code}" \
            -s)

          # Extract HTTP status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Successfully uploaded to NativeBridge!"

            # Parse response
            MAGIC_LINK=$(echo "$BODY" | grep -o '"magicLink":"[^"]*"' | sed 's/"magicLink":"//;s/"//')
            VERSIONED_LINK=$(echo "$BODY" | grep -o '"versionedMagicLink":"[^"]*"' | sed 's/"versionedMagicLink":"//;s/"//')
            NB_VERSION=$(echo "$BODY" | grep -o '"version":"[^"]*"' | sed 's/"version":"//;s/"//')
            APP_ID=$(echo "$BODY" | grep -o '"id":"[^"]*"' | sed 's/"id":"//;s/"//')

            echo "ðŸ“± App ID: $APP_ID"
            echo "ðŸ”¢ NativeBridge Version: $NB_VERSION"
            echo "ðŸ”— Magic Link (Latest): $MAGIC_LINK"
            echo "ðŸ”— Versioned Link: $VERSIONED_LINK"

            # Save to environment
            echo "NATIVEBRIDGE_LINK=$MAGIC_LINK" >> $GITHUB_ENV
            echo "NATIVEBRIDGE_VERSIONED_LINK=$VERSIONED_LINK" >> $GITHUB_ENV
            echo "NATIVEBRIDGE_VERSION=$NB_VERSION" >> $GITHUB_ENV
            echo "NATIVEBRIDGE_APP_ID=$APP_ID" >> $GITHUB_ENV

            # Set outputs
            echo "magic_link=$MAGIC_LINK" >> $GITHUB_OUTPUT
            echo "versioned_link=$VERSIONED_LINK" >> $GITHUB_OUTPUT
            echo "nb_version=$NB_VERSION" >> $GITHUB_OUTPUT
            echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to upload to NativeBridge (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      # Output build info
      - name: Build Summary
        run: |
          echo "### iOS Build Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**App:** NativeBridge-iOS-v${{ steps.get_version.outputs.VERSION }}.app.zip" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${{ env.ZIP_SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Using pre-built iOS app for faster CI/CD" >> $GITHUB_STEP_SUMMARY

          # Add NativeBridge info if uploaded
          if [ -n "${{ env.NATIVEBRIDGE_LINK }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“± NativeBridge Upload âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**App ID:** ${{ env.NATIVEBRIDGE_APP_ID }}" >> $GITHUB_STEP_SUMMARY
            echo "**NativeBridge Version:** ${{ env.NATIVEBRIDGE_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Magic Link (Latest):** [${{ env.NATIVEBRIDGE_LINK }}](${{ env.NATIVEBRIDGE_LINK }})" >> $GITHUB_STEP_SUMMARY
            echo "**Versioned Link:** [${{ env.NATIVEBRIDGE_VERSIONED_LINK }}](${{ env.NATIVEBRIDGE_VERSIONED_LINK }})" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Extract version from tag
      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      # Download Android artifact
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: NativeBridge-Android-v${{ steps.get_version.outputs.VERSION }}
          path: artifacts/

      # Download iOS artifact
      - name: Download iOS .app.zip
        uses: actions/download-artifact@v4
        with:
          name: NativeBridge-iOS-v${{ steps.get_version.outputs.VERSION }}
          path: artifacts/

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.TAG_NAME }}
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.TAG_NAME, 'beta') || contains(steps.get_version.outputs.TAG_NAME, 'alpha') }}
          body: |
            ## NativeBridge Release ${{ steps.get_version.outputs.VERSION }}

            ### ðŸš€ Quick Test via NativeBridge Cloud

            **Run this app instantly in the cloud** - No installation required!

            **â˜ï¸ Android: [Launch in NativeBridge Cloud](${{ needs.build-android.outputs.nativebridge_versioned_link }})**

            **â˜ï¸ iOS: [Launch in NativeBridge Cloud](${{ needs.build-ios.outputs.nativebridge_versioned_link }})**

            #### What is NativeBridge?

            NativeBridge lets you **run Android apps instantly in your browser** using:
            - â˜ï¸ **Cloud Emulators** - Test on virtual Android devices
            - ðŸ“± **Real Physical Devices** - Run on actual Android hardware in the cloud
            - ðŸš€ **One-Click Launch** - No setup, no installation, just click and test
            - ðŸŒ **Any Platform** - Works on Windows, Mac, Linux, even mobile browsers

            #### How to Use:
            1. **Click the NativeBridge link above**
            2. **Choose your test environment:**
               - Cloud emulator (instant, free)
               - Real physical device (actual hardware)
            3. **App launches automatically** in the cloud
            4. **Test and interact** directly in your browser
            5. **Share the link** with your team for instant testing

            > ðŸ’¡ **No Downloads Needed:** Test the app without downloading or installing anything!
            >
            > ðŸ”— **Permanent Link:** This link points to **version ${{ steps.get_version.outputs.VERSION }}** specifically and will always remain available.

            ---

            ### ðŸ“¦ Alternative: Download & Install

            Want to install on your physical device instead?

            **ðŸ“± [Download APK from NativeBridge](${{ needs.build-android.outputs.nativebridge_versioned_link }})**

            ---

            ### ðŸ“¦ Manual Downloads

            **Download from GitHub:**
            - `NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk` - Android APK for devices and emulators
            - `NativeBridge-iOS-v${{ steps.get_version.outputs.VERSION }}.app.zip` - iOS Simulator app

            ### ðŸ“ Installation Methods

            #### Method 1: NativeBridge Platform (Recommended)
            ```
            1. Open NativeBridge link on your Android device
            2. Download and install directly
            3. No computer or ADB required!
            ```

            #### Method 2: ADB Installation
            ```bash
            # Download APK from GitHub Release
            # Then install via ADB
            adb install NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk
            ```

            #### Method 3: Manual Transfer
            ```
            1. Download APK from GitHub Release
            2. Transfer to your Android device (USB/Email/Cloud)
            3. Open APK file on device
            4. Allow installation from unknown sources
            5. Install
            ```

            ### ðŸ”— NativeBridge Links

            **Android:**
            - **Latest Version:** [${{ needs.build-android.outputs.nativebridge_link }}](${{ needs.build-android.outputs.nativebridge_link }}) (always points to newest version)
            - **This Version (v${{ steps.get_version.outputs.VERSION }}):** [${{ needs.build-android.outputs.nativebridge_versioned_link }}](${{ needs.build-android.outputs.nativebridge_versioned_link }}) (permanent link)
            - **App ID:** `${{ needs.build-android.outputs.nativebridge_app_id }}`
            - **NativeBridge Version:** `${{ needs.build-android.outputs.nativebridge_version }}`

            **iOS:**
            - **Latest Version:** [${{ needs.build-ios.outputs.nativebridge_link }}](${{ needs.build-ios.outputs.nativebridge_link }}) (always points to newest version)
            - **This Version (v${{ steps.get_version.outputs.VERSION }}):** [${{ needs.build-ios.outputs.nativebridge_versioned_link }}](${{ needs.build-ios.outputs.nativebridge_versioned_link }}) (permanent link)
            - **App ID:** `${{ needs.build-ios.outputs.nativebridge_app_id }}`
            - **NativeBridge Version:** `${{ needs.build-ios.outputs.nativebridge_version }}`

            ### âœ¨ Features
            - UI Components testing
            - Network Operations testing
            - Performance testing
            - Permissions testing
            - Storage operations
            - File operations
            - Biometric authentication testing
            - QR Code scanning
            - Comprehensive logging

            ### ðŸ“‹ Build Information
            - **APK Version:** ${{ steps.get_version.outputs.VERSION }}
            - **Built on:** ${{ github.event.repository.updated_at }}
            - **Commit:** ${{ github.sha }}
            - **Tag:** ${{ steps.get_version.outputs.TAG_NAME }}

            ---

            **For detailed build instructions, see [BUILD_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/BUILD_GUIDE.md)**
          files: |
            artifacts/NativeBridge-v${{ steps.get_version.outputs.VERSION }}.apk
            artifacts/NativeBridge-iOS-v${{ steps.get_version.outputs.VERSION }}.app.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Final summary
      - name: Release Summary
        run: |
          echo "### ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android APK" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… iOS .app.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
